# Scripts for cleaning epicrisis dates

## Running the whole pipeline

The whole `epicrisis_date_cleaning` pipeline can be executed with the following commands in terminal.

In first terminal window start luigi daemon
```
luigid
```

In the second terminal window execute (define own prefix and configuration file)
```
export PYTHONPATH=~/Repos/cda-data-cleaning:$PYTHONPATH

prefix="run_201909261208"
conf="configurations/egcut_epi_microrun.example.ini"

luigi --scheduler-port 8082 --module cda_data_cleaning.data_cleaning.epicrisis_date_cleaning.run_epicrisis_date_cleaning RunEpicrisisDateCleaning --prefix=$prefix --config=$conf --workers=1 --log-level=INFO
```

The pipeline starts by creating a table **prefix_epi_times** based on three tables:

* patient
* ambulatory_case
* department_stay

The new table contains five cleaned dates:

|column name| description and origin| 
|---|---|
|reporting_time| Epicrisis submission time. Extracted as epi_time from patient
|epi_start| Epicrisis start time. Extracted as effective_time_low from patient
|treatment_start|The first visit from ambulatory_case (a) or start of the first stationary stay from department_stay (s) of the epicrisis
|treatment_end|The last visit from ambulatory_case (a) or end of the last stationary stay from department_stay (s) of the epicrisis
|epi_end|Official closing time for epicrisis. Extracted as effective_time_high from patient

Cleaning of the dates is performed in three steps:

1. All dates are checked to be in the correct time range (by default from 2001 to 2040).
2. Precision of datetime is updated, where needed. For example, if first visit of an epicrisis is given with date precision (12.05.2014 00:00) and start of the epicrisis with time precisision (12.05.2014 14:42), then the visits datetime is changed to contain the time of the day (see step02 for details).
3. The order of dates is controlled and dates are changed (if needed) to restore the right sequence. For example, first visit of an epicrisis cannot be before the start of the epcirisis (see step02 for details).

### Description of steps
**Step 00:** **original.patient**, **original.ambulatory_case** and **original.department_stay** are copied into work schema and named by adding prefix (r01, r02, etc) in front of the old name and _raw in the end. New columns are created into the tables for holding dates in datetime format.

|table|new column name| 
|---|---|
|patient_raw|epi_time_dt_raw
|patient_raw|effective_time_low_dt_raw
|patient_raw|effective_time_high_dt_raw
|ambulatory_case_raw|effective_time_dt_raw 
|department_stay_raw|start_time_dt_raw
|department_stay_raw|end_time_dt_raw

Then the new columns are filled in `prefix_patient_raw`, `prefix_ambulatory_case_raw`,`prefix_department_stay_raw` tables using the psql cleaning function `clean_effective_time` generated by `CreateCleaningFunctions` from `RunAnalysisDataCleaning`. This ensures that every timestamp has the same precision.

**Step 01:** Creates and fills new table into the work schema `prefix_epi_times` with following columns:

|name   |type   |description|compared to original|abbrevation
|---|---|---|---|---|
|id|int|primary autoincrementing key
|epi_id|bigint|epi-id from a_patient|copied
|epi_type|text|stationary or ambulatory (s/a)| copied
|reporting_time_raw|datetime|epi_time_dt from patient_raw|formatted 
|effective_time_low_dt_raw|datetime|effective_time_low_dt_raw from patient_raw|formatted
|effective_time_high_dt_raw|datetime|effective_time_high_dt_raw from patient_raw|formatted
|first_visit_raw|datetime|the first visit from ambulatory_case_raw (a) or start of the first stationary stay from department_stay_raw (s) of the epicrisis|formatted
|last_visit_raw|datetime|the last visit from ambulatory_case_raw (a) or end of the last stationary stay from department_stay_raw (s) of the epicrisis|formatted
|reporting_time|datetime| cleaned reporting time|cleaned|RT
|epi_start|datetime|cleaned effective_time_low|cleaned|ES
|treatment_start|datetime|cleaned first_visit|cleaned|TS
|treatment_end|datetime|cleaned last_visit|cleaned|TE
|epi_end|datetime|cleaned effective_time_high|cleaned|EE
|applyed_cleaning|string|log of all applyed cleaning steps

**Step 02:** Cleans all five datetime columns in `prefix_epi_times` table. Cleaning is done as follows:

For every cleaned value, the step first checks whether the raw value is between 2001 and 2040. If not, the cleaned value will be null. This also means that if the raw time is null, the cleaned value will be null as well.

First, `epi_times` will be given the value of `effective_time_low_dt_raw`. Then `treatment_start` is given whichever value is the greatest between `epi_start` and `first_visit_raw` (which is the corresponding value of treatment_start). The same logic is applied for `treatment_end`, for which the values are the greatest between `treatment_start` and `first_visit_raw`, and `epi_end`, for which the values are the greatest between `treatment_end` and `effective_time_high_dt_raw`.
This ensures that all the chronologically placed events have timestamps in the increasing order (`epi_start` <= `treatment_start` <= `treatment_end` <= `epi_end`). 

**Step 03:** Deletes intermediate tables from the work schema (prefix_ambulatory_case_raw, prefix_patient_raw, prefix_department_stay_raw).