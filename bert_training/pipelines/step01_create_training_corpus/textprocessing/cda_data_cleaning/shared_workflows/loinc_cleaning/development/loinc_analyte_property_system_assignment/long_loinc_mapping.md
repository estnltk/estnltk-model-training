# Process of deriving `long_loinc_mapping` table

Overview of the final CSV file at [long_loinc_mapping.csv](long_loinc_mapping.csv):

| Column name     | Descirption                           | Example    |
|---------------- | ------------------------------------- | ---------- |
| analysis_name   | name of the analysis                  | Hemogramm 5-osalise leukogrammiga |
| parameter_name  | name of the measured parameter        | BASO#      |
| parameter_code  | code of the measured parameter        | B-CBC+Diff |
| unit            | units that the parameter was measured | 10\9/L     |
| analyte         | Component: The analyte being measured               | Baso       |
| property        | The dimension of the analyte that is being measured | Num        |
| system          | The type of sample                                  | Bld        |
| time_aspect     | Whether the analyte is measured at a moment in time or over a specific period of time           | Pt         | 
| scale           | A general classification of the result type, whether quantitative, qualitative, narrative, etc. | Qn         |

Additionally, _Method_ describes how the analyte was measured or the information was 
obtained (examples of which are `null` (no method specified), Immunoassay, Sequencing, 
Invasive, X-ray, MRI, Reported, Observed).

NB! The Method is the only major axis that does not have to be populated for every LOINC term.

Note that `LOINC term = LOINC code + LOINC name` e.g.
`80618-2 Zika virus IgM Ab [Units/​volume] in Cerebral spinal fluid by Immunoassay` = 
`80618-2` + `Zika virus IgM Ab [Units/​volume] in Cerebral spinal fluid by Immunoassay`

* TODO: [Which version](https://loinc.org/downloads/) of LOINC is used by our mapping?
* TODO: How do we know that we are not mapping onto deprecated/discouraged LOINC?


## CSV file format

Currently, or saved file is TAB-separated, without header.

NB! Format updated in `development` branch (with header, comma-separated).

NB! Code in [analysis_data_cleaning/LOINC_cleaning/main.py](main.py), in `LongLoincMappingTable` class
depends from CSV file format, it is read into DB via PostgreSQL's `COPY` command. 


## Steps to derive CSV file content

![Steps to produce analysis_loinced](development/analysis_loinced.png "Files used to create analysis_loinced")

`long_loinc_mapping`
   - files used to get it are 
     under [analysis_data_cleaning/LOINC_cleaning/development/template_extraction](development/template_extraction)        
   - gotten by joining 
        - `long_loinc_mapping_blood`
        - `long_loinc_mapping_urine`
   - added `time_aspect` and `scale` fields
        - everywhere constants `Pt` (point of time) and `Qn` (quantity)
        - code under 
          [development/template_extraction/add_time_scale.sql](development/template_extraction/add_time_scale.sql)

`long_loinc_mapping_blood` and `long_loinc_mapping_urine`
   - gotten by joining 
        - `pre_long_mapping_blood` / `pre_long_mapping_urine` with
        - `short_loinc_mapping_blood` / `short_loinc_mapping_urine`
        - purpose of this process is to improve the mapping
            - mapping actually does not depend on `unit` but in Uku's JSON rules
              which are used for creating `mapped_blood_templates` if unit is missing 
              then observation goes unmapped
            - so with long mapping we map all the rows that were left without mapping 
              because of missing unit 

`pre_long_mapping_blood` / `pre_long_mapping_urine` with
   - file in 
     [development/template_extraction/long_loinc_mapping_blood.sql](development/template_extraction/long_loinc_mapping_blood.sql) 
     or 
     [development/template_extraction/long_loinc_mapping_urine.sql](development/template_extraction/long_loinc_mapping_urine.sql)
   - from `mapped_blood_templates` / `mapped_urine_templates` leaves chosen only interesting columns:
        - `analysis_name`
        - `parameter_name`
        - `parameter_code`
        - `unit`
        - `analyte`
        - `property`
        - `system`

`short_loinc_mapping_blood` / `short_loinc_mapping_urine`
   - from `mapped_blood_templates` / `mapped_urine_templates` chosen only rows which are mapped

`mapped_blood_templates` / `mapped_urine_templates`
   - generated by jupyter notebook code in 
    [development/template_extraction/loinc_mapper_code/blood_mapping.ipynb](development/template_extraction/loinc_mapper_code/blood_mapping.ipynb) and  
    [development/template_extraction/loinc_mapper_code/urine_mapping.ipynb](development/template_extraction/loinc_mapper_code/urine_mapping.ipynb)
   - used Uku's JSON rules for mapping system, analyte and property (3 components of LOINC)

## Why are the names "pre long", "short" and "long" mapping?

   - "pre long" is the initial table where the mapping has not been improved
   - "short" mapping 
        - mapping without unit
        - keeps only rows where analysis_name, parameter_name and parameter_code have a mapping
        - as a lot of rows do not have a mapping, they are not included in the short mapping
          and therefore the table is shorter than the initial table
        - contains only distinct rows
   - "long" mapping
        - again contains all the rows and therefore is longer 
        - all the rows that were previously unmapped because of missing or wrong units now are mapped
        
### Example of pre-long → short → long derivation

#### pre-long mapping
   
| analysis_name | parametre_name, parameter_code | unit | mapping (analyte, property, system) |
|---------------| -------------                  |----- | ------- |
| A   | B | U  | 1 |
| A   | B | -  | - |
| A   | B | V  | - |
| B   | C | U  | 2 |
| B   | C | V  | 1 |
| B   | C | -  | - |

#### short mapping

| analysis_name | parametre_name, parameter_code  | mapping (analyte, property, system) |
|---------------| -------------                   | ------- |
| A   | B   | 1 |
| B   | C   | 2 |
| B   | C   | 1 |

#### long mapping

| analysis_name | parametre_name, parameter_code | unit | mapping (analyte, property, system) |
|---------------| -------------                  |----- | ------- |
| A   | B | U  | 1 |
| A   | B | -  | 1 |
| A   | B | V  | 1 |
| B   | C | U  | 2 |
| B   | C | V  | 1 |
| B   | C | -  | - |
